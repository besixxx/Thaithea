<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ThaiThae Premium | Full System</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { 
            --sat: env(safe-area-inset-top); 
            --sab: env(safe-area-inset-bottom);
            --thai-red: #a50000;
            --thai-bg: #fdfdfd;
        }

        body { font-family: 'Kanit', sans-serif; background-color: var(--thai-bg); margin: 0; min-height: 100svh; display: flex; flex-direction: column; padding-bottom: calc(85px + var(--sab)); }
        header { padding-top: calc(var(--sat) + 1rem); background: white; border-bottom: 3px solid var(--thai-red); box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 20px; }
        .product-card { background: white; border-radius: 1rem; overflow: hidden; border: 1px solid #f0f0f0; display: flex; flex-direction: column; transition: 0.3s; }
        
        .glass-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(70px + var(--sab)); background: white; border-top: 1px solid #eeeeee; padding-bottom: var(--sab); display: flex; justify-content: space-around; align-items: center; z-index: 50; border-radius: 1.5rem 1.5rem 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); }
        .active-nav { color: var(--thai-red); transform: translateY(-2px); }
        .nav-btn { color: #bbbbbb; transition: 0.3s; }

        #loginPage { position: fixed; inset: 0; z-index: 1000; background: var(--thai-bg); display: flex; align-items: center; justify-content: center; }
        .tab-content { display: none; flex: 1; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-red { background: var(--thai-red); color: white; }
        .status-pill { padding: 2px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; }
        .status-pending { background: #fff7ed; color: #c2410c; }
        .status-shipping { background: #eff6ff; color: #1d4ed8; }
        .status-success { background: #f0fdf4; color: #15803d; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="w-full max-w-xs space-y-6 px-6">
            <div class="text-center">
                <h1 class="text-4xl font-black italic">THAI<span class="text-[var(--thai-red)]">THAE</span></h1>
                <p class="text-slate-400 text-[10px] font-bold tracking-widest uppercase">Premium Store & Logistics</p>
            </div>
            <div class="space-y-3">
                <input id="loginUser" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" class="w-full bg-white p-4 rounded-2xl border outline-none font-bold">
                <input id="loginPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full bg-white p-4 rounded-2xl border outline-none font-bold">
            </div>
            <button id="btnLogin" class="w-full btn-red py-4 rounded-2xl font-bold shadow-lg shadow-red-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="homeTab" class="tab-content">
        <header class="px-6 pb-5 sticky top-0 z-40">
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-xl font-black text-slate-800">ThaiThae</h1>
                    <p id="roleLabel" class="text-[10px] text-[var(--thai-red)] font-bold italic"></p>
                </div>
                <button id="headerCartBtn" onclick="switchTab('cartTab', document.getElementById('btnCart'))" class="p-3 bg-slate-50 rounded-2xl relative">
                    <i data-lucide="shopping-basket"></i>
                    <span id="cartCount" class="absolute -top-1 -right-1 bg-[var(--thai-red)] text-white text-[9px] w-5 h-5 rounded-full flex items-center justify-center border-2 border-white font-bold hidden">0</span>
                </button>
            </div>
        </header>
        <main id="productGrid" class="product-grid"></main>
    </div>

    <div id="cartTab" class="tab-content">
        <header class="p-6 bg-white border-b"><h2 class="text-2xl font-black italic">My Basket</h2></header>
        <div id="cartList" class="p-6 space-y-4"></div>
        
        <div id="shippingForm" class="px-6 pb-48 space-y-4 hidden">
            <div class="bg-white p-6 rounded-3xl border shadow-sm space-y-3">
                <p class="font-bold text-sm text-slate-800 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                <input id="shipName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö" class="w-full bg-slate-50 p-3 rounded-xl outline-none border text-sm font-bold">
                <input id="shipPhone" type="tel" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full bg-slate-50 p-3 rounded-xl outline-none border text-sm font-bold">
                <textarea id="shipAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á" class="w-full bg-slate-50 p-3 rounded-xl outline-none border text-sm font-bold h-20"></textarea>
            </div>
        </div>

        <div id="cartSummary" class="px-6 fixed bottom-24 left-0 right-0 hidden z-30">
            <div class="bg-white p-6 rounded-[2.5rem] border shadow-2xl">
                <div class="flex justify-between mb-4"><span class="font-bold text-slate-400">‡∏£‡∏ß‡∏°</span><span id="totalPrice" class="text-3xl font-black text-[var(--thai-red)]">‡∏ø0</span></div>
                <button onclick="processOrder()" class="w-full btn-red py-5 rounded-2xl font-black text-xl active:scale-95 transition-all">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            </div>
        </div>
    </div>

    <div id="historyTab" class="tab-content px-6 pt-6">
        <h2 class="text-2xl font-black text-slate-800 italic mb-6">Order Tracking</h2>
        <div id="orderList" class="space-y-4 pb-32"></div>
    </div>

    <div id="adminTab" class="tab-content px-6 pt-6">
        <h2 class="text-2xl font-black text-slate-800 italic mb-6">Inventory Management</h2>
        <div class="bg-white p-6 rounded-3xl border space-y-4 mb-8">
            <input id="pName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="w-full bg-slate-50 p-4 rounded-xl outline-none font-bold text-sm">
            <div class="flex gap-3">
                <input id="pPrice" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-1/2 bg-slate-50 p-4 rounded-xl outline-none font-bold">
                <input id="pStock" type="number" placeholder="‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" class="w-1/2 bg-slate-50 p-4 rounded-xl outline-none font-bold text-blue-600">
            </div>
            <input id="pImage" type="text" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" class="w-full bg-slate-50 p-3 rounded-xl outline-none text-[10px]">
            <button id="btnSave" class="w-full btn-red py-4 rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
        </div>
        <div id="adminList" class="space-y-4 pb-32"></div>
    </div>

    <nav id="bottomNav" class="glass-nav hidden">
        <button onclick="switchTab('homeTab', this)" class="nav-btn active-nav p-4"><i data-lucide="layout-grid"></i></button>
        <button id="btnCart" onclick="switchTab('cartTab', this)" class="nav-btn p-4"><i data-lucide="shopping-bag"></i></button>
        <button onclick="switchTab('historyTab', this)" class="nav-btn p-4"><i data-lucide="clipboard-list"></i></button>
        <button id="adminNavBtn" onclick="switchTab('adminTab', this)" class="nav-btn p-4 hidden"><i data-lucide="package"></i></button>
        <button onclick="logout()" class="text-slate-300 p-4"><i data-lucide="power"></i></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhV0tNPY5EeiOkIp63U-20rNjscA9WW_s",
            authDomain: "thaithae-ba227.firebaseapp.com",
            databaseURL: "https://thaithae-ba227-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "thaithae-ba227",
            storageBucket: "thaithae-ba227.firebasestorage.app",
            messagingSenderId: "749954534670",
            appId: "1:749954534670:web:bc8e00d9e320dc8d92db5f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, 'products');
        const ordersRef = ref(db, 'orders');

        window.cart = [];
        window.currentUser = '';
        window.currentUserRole = 'customer';

        // --- üõçÔ∏è PRODUCT ENGINE ---
        function loadProducts() {
            onValue(productsRef, (snapshot) => {
                const data = snapshot.val();
                const grid = document.getElementById('productGrid');
                const list = document.getElementById('adminList');
                grid.innerHTML = ''; list.innerHTML = '';
                if (!data) return;

                Object.keys(data).forEach(key => {
                    const item = data[key];
                    const stock = item.stock || 0;
                    const hideBtn = window.currentUserRole === 'admin' ? 'hidden' : '';

                    grid.innerHTML += `
                        <div class="product-card">
                            <img src="${item.image}" class="h-40 w-full object-cover" onerror="this.src='https://via.placeholder.com/150'">
                            <div class="p-3 flex flex-col flex-1">
                                <span class="bg-red-50 text-[var(--thai-red)] text-[9px] font-bold px-2 py-0.5 rounded w-fit mb-1 italic">‡∏Ñ‡∏•‡∏±‡∏á: ${stock}</span>
                                <h3 class="font-bold text-xs line-clamp-1">${item.name}</h3>
                                <p class="text-[var(--thai-red)] font-black">‡∏ø${item.price.toLocaleString()}</p>
                                <button onclick="addToCart('${key}','${item.name}',${item.price},'${item.image}',${stock})" 
                                    class="mt-2 w-full btn-red py-2 rounded-xl text-[10px] font-bold ${hideBtn} ${stock <= 0 ? 'opacity-20 pointer-events-none' : ''}">
                                    ${stock > 0 ? '‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤' : '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î'}
                                </button>
                            </div>
                        </div>`;
                    
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-2xl flex justify-between items-center border">
                            <div class="flex items-center gap-3"><img src="${item.image}" class="w-10 h-10 object-cover rounded-lg"><div><p class="font-bold text-sm">${item.name}</p><p class="text-[10px] text-blue-600 font-bold">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${stock}</p></div></div>
                            <div class="flex gap-1"><button onclick="addStock('${key}',${stock})" class="p-2 text-blue-500"><i data-lucide="plus-circle"></i></button><button onclick="deleteOnlineProduct('${key}')" class="p-2 text-slate-200"><i data-lucide="trash-2"></i></button></div>
                        </div>`;
                });
                lucide.createIcons();
            });
        }

        // --- üìú ORDER ENGINE ---
        window.processOrder = () => {
            const name = document.getElementById('shipName').value.trim();
            const phone = document.getElementById('shipPhone').value.trim();
            const addr = document.getElementById('shipAddress').value.trim();

            if (!name || !phone || !addr) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!");

            const total = window.cart.reduce((sum, item) => sum + item.price, 0);
            const newOrder = {
                user: window.currentUser,
                customerInfo: { name, phone, address: addr },
                items: window.cart,
                total: total,
                status: 'pending',
                timestamp: Date.now()
            };

            push(ordersRef, newOrder).then(() => {
                // ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                window.cart.forEach(cartItem => {
                    onValue(ref(db, `products/${cartItem.id}`), (snap) => {
                        const p = snap.val();
                        if(p) update(ref(db, `products/${cartItem.id}`), { stock: p.stock - 1 });
                    }, { onlyOnce: true });
                });
                
                alert("‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                window.cart = [];
                document.getElementById('cartCount').classList.add('hidden');
                document.querySelectorAll('#shippingForm input, #shippingForm textarea').forEach(i => i.value = '');
                window.switchTab('historyTab', document.querySelector('[onclick*="historyTab"]'));
            });
        };

        function loadOrders() {
            onValue(ordersRef, (snapshot) => {
                const data = snapshot.val();
                const list = document.getElementById('orderList');
                list.innerHTML = '';
                if (!data) return list.innerHTML = '<p class="text-center py-20 opacity-20">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>';

                const orders = Object.keys(data).map(key => ({id: key, ...data[key]})).reverse();
                orders.forEach(order => {
                    if (window.currentUserRole !== 'admin' && order.user !== window.currentUser) return;

                    const info = order.customerInfo || { name: 'N/A', phone: '-', address: '-' };
                    const date = new Date(order.timestamp).toLocaleString('th-TH');
                    let statusClass = order.status === 'pending' ? 'status-pending' : (order.status === 'shipping' ? 'status-shipping' : 'status-success');
                    let statusText = order.status === 'pending' ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : (order.status === 'shipping' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á' : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

                    list.innerHTML += `
                        <div class="bg-white p-5 rounded-2xl border shadow-sm space-y-4">
                            <div class="flex justify-between items-start border-b pb-3">
                                <div><p class="text-[10px] font-bold text-slate-300">#${order.id.slice(-6)}</p><p class="text-xs font-bold">${date}</p></div>
                                <span class="status-pill ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="bg-slate-50 p-3 rounded-xl text-[11px] border-l-4 border-l-[var(--thai-red)]">
                                <p class="font-bold text-slate-800">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${info.name}</p>
                                <p class="text-slate-600">‡πÇ‡∏ó‡∏£: ${info.phone}</p>
                                <p class="text-slate-600 leading-relaxed italic">${info.address}</p>
                            </div>

                            <div class="space-y-1">
                                ${order.items.map(i => `<p class="text-[10px] flex justify-between"><span>${i.name}</span><b>‡∏ø${i.price}</b></p>`).join('')}
                            </div>

                            <div class="flex justify-between items-center pt-3 border-t">
                                <p class="text-xl font-black text-[var(--thai-red)]">‡∏ø${order.total.toLocaleString()}</p>
                                ${window.currentUserRole === 'admin' ? `
                                    <select onchange="updateOrderStatus('${order.id}', this.value)" class="text-[10px] bg-slate-100 p-2 rounded-lg font-bold outline-none">
                                        <option value="pending" ${order.status==='pending'?'selected':''}>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
                                        <option value="shipping" ${order.status==='shipping'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á</option>
                                        <option value="success" ${order.status==='success'?'selected':''}>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
                                    </select>
                                ` : ''}
                            </div>
                        </div>`;
                });
                lucide.createIcons();
            });
        }

        window.updateOrderStatus = (id, status) => update(ref(db, `orders/${id}`), { status });

        // --- üîê AUTH ---
        document.getElementById('btnLogin').onclick = () => {
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value;
            if (pass === "1234" && user !== "") {
                window.currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('bottomNav').classList.remove('hidden');
                document.getElementById('homeTab').classList.add('active');
                
                if (user.toLowerCase() === "admin") {
                    window.currentUserRole = 'admin';
                    document.getElementById('adminNavBtn').classList.remove('hidden');
                    document.getElementById('btnCart').classList.add('hidden');
                    document.getElementById('headerCartBtn').classList.add('hidden');
                }
                document.getElementById('roleLabel').innerText = user.toUpperCase() + " STATUS";
                loadProducts();
                loadOrders();
            } else { alert("Login Failed!"); }
        };

        // --- üõ†Ô∏è UTILS ---
        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(n => n.classList.remove('active-nav'));
            if(btn && btn.classList.contains('nav-btn')) btn.classList.add('active-nav');
            if(tabId === 'cartTab') renderCart();
            lucide.createIcons();
        };

        window.addToCart = (id, name, price, image, stock) => {
            if (window.cart.filter(i => i.id === id).length >= stock) return alert("‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            window.cart.push({id, name, price, image});
            document.getElementById('cartCount').innerText = window.cart.length;
            document.getElementById('cartCount').classList.remove('hidden');
        };

        window.renderCart = () => {
            const list = document.getElementById('cartList');
            const summary = document.getElementById('cartSummary');
            const form = document.getElementById('shippingForm');
            list.innerHTML = ''; let t = 0;
            if(window.cart.length === 0) { 
                list.innerHTML = '<div class="py-20 text-center opacity-20"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p></div>'; 
                summary.classList.add('hidden'); form.classList.add('hidden'); return; 
            }
            window.cart.forEach((item, index) => {
                t += item.price;
                list.innerHTML += `<div class="bg-white p-4 rounded-xl flex justify-between items-center border">
                    <div class="flex items-center gap-3"><img src="${item.image}" class="w-10 h-10 object-cover rounded-lg"><div><p class="font-bold text-xs">${item.name}</p><p class="text-[var(--thai-red)] font-bold text-xs">‡∏ø${item.price}</p></div></div>
                    <button onclick="window.cart.splice(${index},1);window.renderCart();"><i data-lucide="trash-2" class="w-5 h-5 text-slate-200"></i></button></div>`;
            });
            document.getElementById('totalPrice').innerText = `‡∏ø${t.toLocaleString()}`;
            summary.classList.remove('hidden'); form.classList.remove('hidden'); lucide.createIcons();
        };

        document.getElementById('btnSave').onclick = () => {
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            const stock = document.getElementById('pStock').value;
            const image = document.getElementById('pImage').value;
            if(name && price && stock && image) push(productsRef, { name, price: Number(price), stock: Number(stock), image });
            document.querySelectorAll('input').forEach(i => i.value = '');
        };

        window.addStock = (key, current) => {
            const n = prompt("‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô?:", "10");
            if(n) update(ref(db, `products/${key}`), { stock: Number(current) + Number(n) });
        };

        window.deleteOnlineProduct = (key) => { if(confirm("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?")) remove(ref(db, `products/${key}`)); };
        window.logout = () => location.reload();
        lucide.createIcons();
    </script>
</body>
</html>